
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Ответ:

| Решение       | Маршрутизация запросов     | Проверка аутентификации в запросах                         | Терминация HTTPS |
| ------------- |:--------------------------:| ----------------------------------------------------------:|-----------------:|
| Azure API     |  Azure API поддерживает новый тип маршрутизации, называемый маршрутизацией атрибутов. Как следует из названия, маршрутизация атрибутов использует атрибуты для определения маршрутов. Маршрутизация атрибутов обеспечивает больший контроль над URI в веб-API. Например, можно легко создавать URI, описывающие иерархии ресурсов. Предыдущий стиль маршрутизации, называемый маршрутизацией на основе соглашений, по-прежнему полностью поддерживается. | Каждый вызов REST API, отправляемый в приложение IoT Central, должен включать заголовок авторизации. Заголовок Authorization должен содержать маркер API или маркер носителя AAD. Эти маркеры используются IoT Central для определения того, кто является вызывающим и к чему он имеет доступ в приложении.| Шлюз приложений поддерживает завершение сеансов TLS на шлюзе, после чего трафик обычно передается в незашифрованном виде на внутренние серверы. Завершение сеансов TLS на шлюзе приложений дает ряд преимуществ: Улучшенная производительность, Более эффективное использование внутренних серверов, Интеллектуальная маршрутизация, Управление сертификатами |
| nginx         | Маршрутизация запросов настраивается через location. Необходимо использовать регулярное выражение для определения микросервиса, на который будет направлен запрос | NGINX обладает возможностью выполнять аутентификацию клиентов. Запросы аутентификации клиента при помощи NGINX разгружает работу и предоставляет возможность прекращать попадание на ваши серверы запросов без аутентификации. Доступные для NGINX с открытым исходным кодом модули включают базовую аутентификацию и подзапросы аутентификации. Имеющийся исключительно в NGINX Plus модуль проверки JWT (JSON Web Tokens) делает возможной интеграцию со сторонними производителями аутентификации, которые применяют стандарт OpenID Connect. |Nginx можно настроить как балансировщик нагрузки, что позволяет распределять входящий трафик между несколькими внутренними серверами. SSL-терминация является процессом на балансировщике нагрузки, который обрабатывает шифрование и дешифровку SSL таким образом, чтобы трафик между балансировщиком и внутренними серверами был в HTTP. Серверы на бэкэнде должны  быть защищены путем ограничения доступа к IP балансировщика нагрузки |
| haproxy       | В разделе frontend конфига haproxy мы можем настроить несколько директив. Директива «bind» используется для указания того, какой порт HAProxy будет прослушивать. Директивы «acl» определяют критерии для маршрутизации входящего трафика. Первый параметр, следующий за директивой, является просто внутренним именем для будущей ссылки, а остальные параметры определяют методы, используемые для сопоставления некоторого элемента входящего запроса, который используется в качестве основы для маршрутизации | Haproxy поддерживает Basic Authentication, Client Certificate Authentication, JSON Web Token-Based Authorization | Haproxy поддерживает ssl-терминацию для запросов к микросервисам, для этого нужно настроить сертификат SSL на самом Haproxy. Также haproxy поддерживает ssl verify none — терминацию SSL-сертификата, игнорирующая ошибки |

Я предлагаю воспользоваться решением haproxy. HAProxy активно используется в различных высоконагруженных веб-сайтах, таких как Instagram, Twitter, Reddit и т.д. К числу его основных функций можно отнести:

- Бесплатное решение
- Балансировка HTTP и TCP соединений
- Маршрутизация запросов
- Возможность перезапуска без потери активных соединений
- Встроенный веб-интерфейс для просмотра статистики с HTTP basic аутентификацией
- Возможность аутентификации запросов по сертификату и токену
- Возможность терминировать SSL (можно ставить перед веб-приложениями вместо nginx)


## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

## Ответ

| Решение       | поддержка кластеризации для обеспечения надёжности | хранение сообщений на диске в процессе доставки | высокая скорость работы | поддержка различных форматов сообщений | разделение прав доступа к различным потокам сообщений | простота эксплуатации |
| ------------- |:--------------------------:| ----------------------------------------------------------:|-----------------:|-----------------:|-----------------:|-----------------:|
| kafka     |  |  | Акцент на потоковом контенте, работа с большими потоками данных | | | |
| ngRabbitMQ | выровнен по центру         |   $12                                                      |                  | | | |
| SNS/SQS  | прикольные                 |    $1                                                      |                  | | | |

Четкая работа микросервисных приложений в значительной степени зависит от передачи сообщений и асинхронных операций.

Правильный выбор брокера сообщений — это одно из первых важных решений, которое потребуется принять при разработке взаимодействующих сервисов. Поиск подходящего решения может превратиться в мучительное сравнение функций и пограничных вариантов, которые мало отличаются друг от друга.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
